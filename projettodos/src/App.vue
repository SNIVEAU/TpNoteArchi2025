<script>
import AddQuestionnaire from './components/addQuestionnaire.vue';
import QuestionItem from './components/QuestionItem.vue';
import TodoItem from './components/TodoItem.vue';
let data = {
  questionnaires: [],
  questions: [],
  todos: [
    { text: 'Faire les courses', checked: true,id:1 },
    { text: 'Apprendre REST', checked: false ,id:2}
  ],
  title: 'Mes tâches',
  newItem: ''
};
export default {
  data() {
    return data;
  },
  components:{
    TodoItem,
    QuestionItem,
    AddQuestionnaire
  },
  mounted() {
    this.fetchQuestionnaire();
    this.fetchQuestion();
  },
  methods: {
    addItem: function () {
      let text = this.newItem.trim();
      let id=0;
      this.todos.forEach(todo => {
        if (todo.id>id){
          id=todo.id
        }
      });
      if (text) {
        this.todos.push({
          text: text,
          checked: false,
          id:id+1
        });
        this.newItem = '';
      }
    },
    fetchQuestionnaire: function () {
      fetch('http://127.0.0.1:5000/todo/api/v1.0/questionnaires')
        .then(response => response.json())
        .then(data => {
          this.questionnaires = data;
          console.log(this.questionnaires);
        })
        .catch(error => {
          console.error('Error fetching data:', error);
        });
    },
    fetchQuestion: function () {
      fetch('http://127.0.0.1:5000/todo/api/v1.0/questions')
        .then(response => response.json())
        .then(data => {
          this.questions = data['question'];
          console.log(this.questions);
        })
        .catch(error => {
          console.error('Error fetching data:', error);
        });
    },
    removeItem: function(id) {
      console.log(id)
      for (let index = 0; index < this.todos.length; index++) {
        if (this.todos[index].id==id.id){
          this.todos.splice(index, 1);
        }
      }
    },
    edittodo: function(id,newtext) {
      for (let index = 0; index < this.todos.length; index++) {
        if (this.todos[index].text==id.id){
          this.todos[index].text = newtext
        }
      }
    },
    removeQuestion(id) {
      fetch(`http://127.0.0.1:5000/todo/api/v1.0/questions/${id}`, {
        method: 'DELETE',
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('erreur lors de la suppression');
          }
          this.questions = this.questions.filter(question => question.id !== id);
        })
        .catch(error => {
          console.error('erreur lors de la suppression', error);
        });
    },
    newQuestionnaire(nouveauNom){
      fetch('http://127.0.0.1:5000/todo/api/v1.0/questionnaires', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ name: nouveauNom }),
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Erreur lors de la création du questionnaire');
          }
          return response.json();
        })
        .then(data => {
          this.questionnaires.push(data);
          console.log('Questionnaire ajouté avec succès:', data);
        })
        .catch(error => {
          console.error('Erreur lors de la création du questionnaire:', error);
        });
    },

    putQuestion(id, updatedQuestion, questionnaire_id) {
      const datajson = {
        title: updatedQuestion,
        questionnaire_id: questionnaire_id
      };
      fetch(`http://127.0.0.1:5000/todo/api/v1.0/questions/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(datajson),
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('erreur lors de la mise à jour');
          }
          return response.json();
        })
        .then(data => {
          for (let index = 0; index < this.questions.length; index++) {
            if (this.questions[index].id==id){
              this.questions[index].title = updatedQuestion;
            }
          }
          console.log('Mise à jour réussie:', data);
        })
        .catch(error => {
          console.error('Erreur lors de la mise à jour:', error);
        });

    },


  }
};
</script>
<template>
  <link 
    rel="stylesheet" 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" 
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" 
    crossorigin="anonymous"
  >
  <div class="container">
    <h2>{{ title }}</h2>
    <ol>
      <li 
        v-for="todo in this.todos" 
        v-bind:class="{ 'alert alert-success': todo.checked }"
      >

        <TodoItem @remove="removeItem" @put="edittodo" :todo="todo"></TodoItem>
      </li>
    </ol>
    <div>
      <div v-for="question in questions" :key="question.id">
        
        <QuestionItem 
          :question="question" 
          @remove="removeQuestion"
          @putquestion="putQuestion"
        ></QuestionItem>
      </div>
    </div>
    <div class="input-group">
      <AddQuestionnaire @addQuestionnaire="newQuestionnaire(this.nouveauNom)"></AddQuestionnaire>
    </div>
  </div>
</template>
<style scoped>
.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.vue:hover {
  filter: drop-shadow(0 0 2em #42b883aa);
}
</style>
